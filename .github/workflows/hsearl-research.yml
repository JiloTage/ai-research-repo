name: HSEARL Research Pipeline (Claude Code)

on:
  schedule:
    # 20åˆ†ã”ã¨ã«å®Ÿè¡Œ
    - cron: '*/20 * * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹
  push:
    branches:
      - master
    paths:
      - 'docs/prompts/**'
      - '.github/workflows/hsearl-research.yml'

jobs:
  create_claude_task:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Check for pending tasks
      id: check_tasks
      run: |
        echo "=== HSEARLç ”ç©¶èª¿æŸ»ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ ==="
        
        # ã‚µãƒ¼ãƒ™ã‚¤äºˆå®šè«–æ–‡ãƒªã‚¹ãƒˆã®ç¢ºèª
        if [ -f "docs/ã‚µãƒ¼ãƒ™ã‚¤äºˆå®šè«–æ–‡ãƒªã‚¹ãƒˆ.md" ]; then
          PENDING_PAPERS=$(grep -c "https://arxiv.org/abs/" "docs/ã‚µãƒ¼ãƒ™ã‚¤äºˆå®šè«–æ–‡ãƒªã‚¹ãƒˆ.md" || echo "0")
          echo "å‡¦ç†å¾…ã¡è«–æ–‡: ${PENDING_PAPERS}ä»¶"
        else
          PENDING_PAPERS=0
          echo "ã‚µãƒ¼ãƒ™ã‚¤äºˆå®šè«–æ–‡ãƒªã‚¹ãƒˆ: æœªä½œæˆ"
        fi
        
        # æœªå‡¦ç†ã‚µãƒãƒªãƒ¼ã®ç¢ºèª
        PENDING_SUMMARIES=0
        if [ -d "docs/surveys" ]; then
          TOTAL_SUMMARIES=$(find docs/surveys -name "*.md" | wc -l)
          if [ -f "docs/processed_ideas.json" ]; then
            PROCESSED_SUMMARIES=$(jq length docs/processed_ideas.json 2>/dev/null || echo "0")
          else
            PROCESSED_SUMMARIES=0
          fi
          PENDING_SUMMARIES=$((TOTAL_SUMMARIES - PROCESSED_SUMMARIES))
          echo "æœªå‡¦ç†ã‚µãƒãƒªãƒ¼: ${PENDING_SUMMARIES}ä»¶"
        else
          echo "ã‚µãƒãƒªãƒ¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: æœªä½œæˆ"
        fi
        
        # Claude Codeå®Ÿè¡ŒãŒå¿…è¦ã‹ã©ã†ã‹ã‚’åˆ¤å®š
        if [ "$PENDING_PAPERS" -gt 0 ] || [ "$PENDING_SUMMARIES" -gt 0 ]; then
          echo "claude_tasks=true" >> $GITHUB_OUTPUT
          echo "pending_papers=${PENDING_PAPERS}" >> $GITHUB_OUTPUT
          echo "pending_summaries=${PENDING_SUMMARIES}" >> $GITHUB_OUTPUT
          echo "âœ… Claude Codeå®Ÿè¡ŒãŒå¿…è¦ã§ã™"
        else
          echo "claude_tasks=false" >> $GITHUB_OUTPUT
          echo "âœ… ç¾åœ¨å‡¦ç†å¾…ã¡ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“"
        fi
        
        echo "============================================"
    
    - name: Create Claude Code task issue
      if: steps.check_tasks.outputs.claude_tasks == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const pendingPapers = ${{ steps.check_tasks.outputs.pending_papers }};
          const pendingSummaries = ${{ steps.check_tasks.outputs.pending_summaries }};
          
          let taskList = [];
          let executionInstructions = [];
          
          // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã®ç”Ÿæˆ
          if (pendingPapers > 0) {
            taskList.push(`ğŸ“„ **è«–æ–‡æ¤œç´¢ãƒ»ã‚µãƒãƒªãƒ¼ç”Ÿæˆ**: ${pendingPapers}ä»¶ã®å‡¦ç†å¾…ã¡è«–æ–‡`);
            executionInstructions.push(`
          ### 1. è«–æ–‡æ¤œç´¢ã¨ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
          
          \`\`\`
          docs/prompts/hsearl_research_pipeline.mdã®çµ±åˆå®Ÿè¡Œæ‰‹é †æ›¸ã«å¾“ã£ã¦ã€
          HSEARLç ”ç©¶èª¿æŸ»ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
          
          ãƒ•ã‚§ãƒ¼ã‚º1: ArXivè«–æ–‡æ¤œç´¢
          ãƒ•ã‚§ãƒ¼ã‚º2: è«–æ–‡ã‚µãƒãƒªãƒ¼ç”Ÿæˆï¼ˆ${pendingPapers}ä»¶å‡¦ç†å¾…ã¡ï¼‰
          \`\`\`
          
          **é‡è¦äº‹é …**:
          - WebSearchãƒ„ãƒ¼ãƒ«ã§ArXivã‹ã‚‰æ–°è¦è«–æ–‡ã‚’æ¤œç´¢
          - WebFetchãƒ„ãƒ¼ãƒ«ã§è«–æ–‡è©³ç´°ã‚’å–å¾—
          - è½åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ + HSEARLã¨ã®é–¢é€£æ€§åˆ†æ
          - docs/surveys/ã«ä¿å­˜å¾Œã€ã‚µãƒ¼ãƒ™ã‚¤äºˆå®šãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤`);
          }
          
          if (pendingSummaries > 0) {
            taskList.push(`ğŸ’¡ **ã‚¢ã‚¤ãƒ‡ã‚¢ç”Ÿæˆ**: ${pendingSummaries}ä»¶ã®æœªå‡¦ç†ã‚µãƒãƒªãƒ¼`);
            executionInstructions.push(`
          ### 2. ã‚¢ã‚¤ãƒ‡ã‚¢ç”Ÿæˆ
          
          \`\`\`
          docs/prompts/idea_generation_prompt.mdã®æ‰‹é †æ›¸ã«å¾“ã£ã¦ã€
          æœªå‡¦ç†ã®ã‚µãƒãƒªãƒ¼ã‹ã‚‰HSEARLã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‰µå‡ºã—ã¦ãã ã•ã„ã€‚
          \`\`\`
          
          **é‡è¦äº‹é …**:
          - HSEARLã®6ã¤ã®è¦³ç‚¹ã™ã¹ã¦ã‹ã‚‰ã‚¢ã‚¤ãƒ‡ã‚¢ç”Ÿæˆ
          - å…·ä½“çš„ã§å®Ÿè£…å¯èƒ½ãªé©æ–°çš„ã‚¢ã‚¤ãƒ‡ã‚¢
          - docs/idea/ã«ä¿å­˜ã€å‡¦ç†æ¸ˆã¿è¨˜éŒ²ã‚’æ›´æ–°`);
          }
          
          const issueBody = \`## ğŸ¤– Claude Codeå®Ÿè¡Œè¦è«‹
          
          HSEARLç ”ç©¶èª¿æŸ»ã‚·ã‚¹ãƒ†ãƒ ã®å®šæœŸå®Ÿè¡Œã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯ã§Claude Codeã®å®Ÿè¡ŒãŒå¿…è¦ã§ã™ï¼š
          
          ${taskList.join('\n')}
          
          ## å®Ÿè¡Œæ‰‹é †
          ${executionInstructions.join('\n')}
          
          ## çµ±åˆå®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰
          
          \`\`\`
          docs/prompts/hsearl_research_pipeline.mdã«å¾“ã£ã¦ã€
          HSEARLç ”ç©¶èª¿æŸ»ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
          
          1. ArXivè«–æ–‡æ¤œç´¢
          2. è«–æ–‡ã‚µãƒãƒªãƒ¼ç”Ÿæˆ  
          3. ã‚¢ã‚¤ãƒ‡ã‚¢å‰µå‡º
          4. çµæœå ±å‘Š
          
          å„ãƒ•ã‚§ãƒ¼ã‚ºã§é©åˆ‡ãªãƒ„ãƒ¼ãƒ«ï¼ˆWebSearchã€WebFetchã€Readã€Writeã€Editï¼‰ã‚’ä½¿ç”¨ã—ã€
          HSEARLã¨ã®é–¢é€£æ€§ã‚’é‡è¦–ã—ãŸé«˜å“è³ªãªã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
          \`\`\`
          
          ## å“è³ªåŸºæº–
          
          ### å¿…é ˆè¦ä»¶
          - HSEARLã¨ã®æ˜ç¢ºãªé–¢é€£æ€§åˆ†æ
          - å…·ä½“çš„ã§å®Ÿè£…å¯èƒ½ãªææ¡ˆ
          - æŠ€è¡“çš„æ­£ç¢ºæ€§ã¨é©æ–°æ€§
          - é©åˆ‡ãªãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
          
          ### å®Œäº†å¾Œ
          
          å…¨ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰ã€ã“ã®issueã‚’closeã—ã¦ãã ã•ã„ã€‚
          
          ## å‚è€ƒè³‡æ–™
          
          - [HSEARLå®šç¾©](docs/base/HSEARLï¼ˆãƒãƒ¼ãƒ«ï¼‰.md)
          - [çµ±åˆå®Ÿè¡Œæ‰‹é †](docs/prompts/hsearl_research_pipeline.md)
          - [è«–æ–‡æ¤œç´¢æ‰‹é †](docs/prompts/arxiv_search_prompt.md)
          - [ã‚µãƒãƒªãƒ¼ç”Ÿæˆæ‰‹é †](docs/prompts/paper_summary_prompt.md)
          - [ã‚¢ã‚¤ãƒ‡ã‚¢ç”Ÿæˆæ‰‹é †](docs/prompts/idea_generation_prompt.md)
          - [ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“èª¬æ˜](CLAUDE.md#hsearlç ”ç©¶è«–æ–‡èª¿æŸ»ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ™ãƒ¼ã‚¹)
          
          ---
          *è‡ªå‹•ç”Ÿæˆæ—¥æ™‚: ${new Date().toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'})}*
          *å‡¦ç†å¾…ã¡è«–æ–‡: ${pendingPapers}ä»¶ | æœªå‡¦ç†ã‚µãƒãƒªãƒ¼: ${pendingSummaries}ä»¶*\`;
          
          // Check if there's already an open issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'claude-code-task'
          });
          
          if (issues.data.length === 0) {
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: \`ğŸ¤– HSEARLç ”ç©¶èª¿æŸ»å®Ÿè¡Œè¦è«‹ - ${new Date().toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'})}\`,
              body: issueBody,
              labels: ['claude-code-task', 'automation', 'hsearl-research']
            });
            console.log('âœ… æ–°ã—ã„Claude Codeå®Ÿè¡Œè¦è«‹issueã‚’ä½œæˆã—ã¾ã—ãŸ');
          } else {
            // Update existing issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues.data[0].number,
              title: \`ğŸ¤– HSEARLç ”ç©¶èª¿æŸ»å®Ÿè¡Œè¦è«‹ - ${new Date().toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'})}\`,
              body: issueBody
            });
            console.log('âœ… æ—¢å­˜ã®Claude Codeå®Ÿè¡Œè¦è«‹issueã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          }
    
    - name: Summary
      run: |
        echo "=== å®Ÿè¡Œå®Œäº†ã‚µãƒãƒªãƒ¼ ==="
        echo "å®Ÿè¡Œæ—¥æ™‚: $(date +'%Y-%m-%d %H:%M:%S')"
        echo "å‡¦ç†å¾…ã¡è«–æ–‡: ${{ steps.check_tasks.outputs.pending_papers }}ä»¶"
        echo "æœªå‡¦ç†ã‚µãƒãƒªãƒ¼: ${{ steps.check_tasks.outputs.pending_summaries }}ä»¶"
        if [ "${{ steps.check_tasks.outputs.claude_tasks }}" = "true" ]; then
          echo "Claude Codeå®Ÿè¡Œè¦è«‹: âœ… ä½œæˆæ¸ˆã¿"
        else
          echo "Claude Codeå®Ÿè¡Œè¦è«‹: â¸ï¸  ä¸è¦ï¼ˆå‡¦ç†å¾…ã¡ã‚¿ã‚¹ã‚¯ãªã—ï¼‰"
        fi
        echo "=========================="